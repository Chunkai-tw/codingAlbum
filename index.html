<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç§‘ä¸çš„ç›¸ç°¿</title>
    <!-- å¼•å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥ Lucide Icons for aesthetic buttons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; /* Light background */
        }
        /* Custom scrollbar for aesthetics */
        .scene-container::-webkit-scrollbar {
            height: 8px;
        }
        .scene-container::-webkit-scrollbar-thumb {
            background-color: #6366f1;
            border-radius: 4px;
        }
        .scene-container::-webkit-scrollbar-track {
            background-color: #e0e7ff;
            border-radius: 4px;
        }
    </style>
</head>
<body class="min-h-screen flex items-start justify-center p-4">
    <div id="app" class="w-full max-w-4xl bg-white shadow-2xl rounded-xl p-6 md:p-10 mt-8">
        <h1 class="text-4xl font-bold text-indigo-700 text-center mb-6">ğŸ“¸ ç§‘ä¸çš„ç›¸ç°¿</h1>

        <!-- 1. ä¸»é¸å–® (Menu View) -->
        <div id="menuView" class="view">
            <h2 class="text-2xl font-semibold text-gray-700 mb-6 text-center">æ­¥é©Ÿ 1ï¼šè«‹é¸æ“‡å¹´ç´š</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <button onclick="startGradeFlow('1-3')" class="flex flex-col items-center justify-center p-8 bg-indigo-500 hover:bg-indigo-600 text-white font-bold text-xl rounded-xl shadow-lg transition duration-300 transform hover:scale-[1.02]">
                    <i data-lucide="graduation-cap" class="w-10 h-10 mb-2"></i>
                    ä¸€äºŒä¸‰å¹´ç´š
                </button>
                <button onclick="startGradeFlow('4-6')" class="flex flex-col items-center justify-center p-8 bg-purple-500 hover:bg-purple-600 text-white font-bold text-xl rounded-xl shadow-lg transition duration-300 transform hover:scale-[1.02]">
                    <i data-lucide="book-open-text" class="w-10 h-10 mb-2"></i>
                    å››äº”å…­å¹´ç´š (é€šé—œå¯†ç¢¼æ¨¡å¼)
                </button>
            </div>
            <p class="mt-6 text-center text-sm text-gray-500">â€» å››äº”å…­å¹´ç´šéœ€é€šéå¯†ç¢¼é©—è­‰æ‰å¯å•Ÿå‹•ç›¸æ©Ÿã€‚</p>
        </div>

        <!-- 2A. å ´æ™¯é¸æ“‡ (Scene Selection View) - é©ç”¨æ–¼ä¸€äºŒä¸‰å¹´ç´š -->
        <div id="sceneSelectionView" class="view hidden">
            <h2 class="text-2xl font-semibold text-gray-700 mb-6 text-center">æ­¥é©Ÿ 2ï¼šé¸æ“‡ä¸€å€‹å ´æ™¯ (ä¸€äºŒä¸‰å¹´ç´š)</h2>
            <div id="scenesContainer" class="scene-container flex overflow-x-auto space-x-4 p-4 rounded-xl bg-gray-50 shadow-inner">
                <!-- Scenes will be loaded here -->
            </div>
            <div class="flex justify-center mt-6">
                <button onclick="showView('menuView')" class="flex items-center space-x-2 px-6 py-2 bg-gray-200 text-gray-700 font-semibold rounded-full hover:bg-gray-300 transition duration-200">
                    <i data-lucide="arrow-left" class="w-5 h-5"></i>
                    <span>è¿”å›é¸å–®</span>
                </button>
            </div>
        </div>

        <!-- 2B. æ ¡åœ’å•ç­”ä¸€ (Quiz 1: Scene View) - é©ç”¨æ–¼å››äº”å…­å¹´ç´š -->
        <div id="quizSceneView" class="view hidden">
            <h2 class="text-2xl font-semibold text-gray-700 mb-6 text-center">æ­¥é©Ÿ 2Aï¼šæ ¡åœ’å•ç­”</h2>
            <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                <p class="text-xl font-bold text-indigo-600 mb-4">é¡Œç›®ï¼šä½ æœ€å–œæ­¡æ ¡åœ’çš„å“ªä¸€å€‹å ´æ™¯ï¼Ÿ</p>
                <div id="quizSceneOptionsContainer" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Options will be rendered here by JavaScript -->
                </div>
            </div>
            <div class="flex justify-center mt-6">
                <button onclick="showView('menuView')" class="flex items-center space-x-2 px-6 py-2 bg-gray-200 text-gray-700 font-semibold rounded-full hover:bg-gray-300 transition duration-200">
                    <i data-lucide="arrow-left" class="w-5 h-5"></i>
                    <span>è¿”å›é¸å–®</span>
                </button>
            </div>
        </div>

        <!-- 2C. è¨˜æ†¶æç¤ºç•«é¢ä¸€ (Memory 1: Scene Digit) -->
        <div id="memorySceneView" class="view hidden">
            <div class="flex flex-col items-center justify-center p-8 bg-pink-100 rounded-xl shadow-2xl border-4 border-pink-500">
                <h2 class="text-3xl font-bold text-pink-700 mb-6 text-center">ğŸ§  è¨˜æ†¶æç¤ºï¼šç¬¬ä¸€å€‹æ•¸å­—</h2>
                <p class="text-xl text-gray-700 mb-8 text-center">è«‹å‹™å¿…**è¨˜ä½**æ‚¨é¸æ“‡çš„é¸é …æ•¸å­—ã€‚</p>
                <div id="memorySceneNumberContainer" class="p-8 bg-pink-500 text-white font-black text-9xl rounded-2xl shadow-xl animate-pulse">
                    <!-- The number will be displayed here -->
                </div>
                <p class="mt-8 text-2xl font-semibold text-pink-900 text-center">é€™æ˜¯é€šé—œå¯†ç¢¼çš„ç¬¬ä¸€å€‹æ•¸å­—ï¼</p>
            </div>
            <div class="flex justify-center mt-6">
                <button onclick="showQuizStyleView()" class="flex items-center space-x-2 px-8 py-3 bg-pink-600 text-white font-bold text-lg rounded-full shadow-lg hover:bg-pink-700 transition duration-200">
                    <i data-lucide="arrow-right" class="w-6 h-6"></i>
                    <span>é€²å…¥ä¸‹ä¸€æ­¥ï¼šå•ç­”äºŒ (é¢¨æ ¼)</span>
                </button>
            </div>
        </div>

        <!-- 3A. é¢¨æ ¼é¸æ“‡ (Style Selection View) - é©ç”¨æ–¼ä¸€äºŒä¸‰å¹´ç´š -->
        <div id="styleSelectionView" class="view hidden">
            <h2 class="text-2xl font-semibold text-gray-700 mb-6 text-center">æ­¥é©Ÿ 3ï¼šé¸æ“‡ç¹ªåœ–é¢¨æ ¼ (ä¸€äºŒä¸‰å¹´ç´š)</h2>
            <div id="stylesContainer" class="flex flex-wrap justify-center gap-4 p-4 rounded-xl bg-gray-50 shadow-inner">
                <!-- Styles will be loaded here by JavaScript -->
            </div>
            <div class="flex justify-center space-x-4 mt-6">
                <button onclick="startGradeFlow(window.currentGrade)" class="flex items-center space-x-2 px-6 py-2 bg-gray-200 text-gray-700 font-semibold rounded-full hover:bg-gray-300 transition duration-200">
                    <i data-lucide="arrow-left" class="w-5 h-5"></i>
                    <span>è¿”å›ä¸Šä¸€æ­¥</span>
                </button>
            </div>
        </div>

        <!-- 3B. æ ¡åœ’å•ç­”äºŒ (Quiz 2: Style View) - é©ç”¨æ–¼å››äº”å…­å¹´ç´š -->
        <div id="quizStyleView" class="view hidden">
            <h2 class="text-2xl font-semibold text-gray-700 mb-6 text-center">æ­¥é©Ÿ 2Bï¼šæ ¡åœ’å•ç­”</h2>
            <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                <p class="text-xl font-bold text-indigo-600 mb-4">é¡Œç›®ï¼šä½ æƒ³å˜—è©¦çš„åˆæˆé¢¨æ ¼ï¼Ÿ</p>
                <div id="quizStyleOptionsContainer" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Options will be rendered here by JavaScript -->
                </div>
            </div>
            <div class="flex justify-center mt-6">
                <button onclick="showQuizSceneView()" class="flex items-center space-x-2 px-6 py-2 bg-gray-200 text-gray-700 font-semibold rounded-full hover:bg-gray-300 transition duration-200">
                    <i data-lucide="arrow-left" class="w-5 h-5"></i>
                    <span>è¿”å›å•ç­”ä¸€</span>
                </button>
            </div>
        </div>

        <!-- 3C. è¨˜æ†¶æç¤ºç•«é¢äºŒ (Memory 2: Style Digit) -->
        <div id="memoryStyleView" class="view hidden">
            <div class="flex flex-col items-center justify-center p-8 bg-green-100 rounded-xl shadow-2xl border-4 border-green-500">
                <h2 class="text-3xl font-bold text-green-700 mb-6 text-center">ğŸ§  è¨˜æ†¶æç¤ºï¼šç¬¬äºŒå€‹æ•¸å­—</h2>
                <p class="text-xl text-gray-700 mb-8 text-center">è«‹å‹™å¿…**è¨˜ä½**æ‚¨é¸æ“‡çš„é¸é …æ•¸å­—ã€‚</p>
                <div id="memoryStyleNumberContainer" class="p-8 bg-green-500 text-white font-black text-9xl rounded-2xl shadow-xl animate-pulse">
                    <!-- The number will be displayed here -->
                </div>
                <p class="mt-8 text-2xl font-semibold text-green-900 text-center">é€™æ˜¯é€šé—œå¯†ç¢¼çš„ç¬¬äºŒå€‹æ•¸å­—ï¼</p>
            </div>
            <div class="flex justify-center mt-6">
                <button onclick="showQuizAnniversaryView()" class="flex items-center space-x-2 px-8 py-3 bg-green-600 text-white font-bold text-lg rounded-full shadow-lg hover:bg-green-700 transition duration-200">
                    <i data-lucide="arrow-right" class="w-6 h-6"></i>
                    <span>é€²å…¥ä¸‹ä¸€æ­¥ï¼šå•ç­”ä¸‰ (æ ¡æ…¶)</span>
                </button>
            </div>
        </div>

        <!-- 4. æ ¡æ…¶å•ç­”ä¸‰ (Quiz 3: Anniversary View) - é©ç”¨æ–¼å››äº”å…­å¹´ç´š -->
        <div id="quizAnniversaryView" class="view hidden">
            <h2 class="text-2xl font-semibold text-gray-700 mb-6 text-center">æ­¥é©Ÿ 2Cï¼šæ ¡åœ’å•ç­”</h2>
            <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200 flex flex-col items-center">
                <p class="text-xl font-bold text-indigo-600 mb-4 text-center">é¡Œç›®ï¼šè«‹å•ä»Šå¹´æ˜¯å¤§æˆåœ‹å°å‰µæ ¡ç¬¬å¹¾é€±å¹´æ ¡æ…¶ï¼Ÿ</p>
                <!-- æ ¹æ“šä½¿ç”¨è€…è¦æ±‚ä¿®æ”¹æç¤ºè© -->
                <p class="text-3xl font-black text-red-500 mb-6">è«‹å‹™å¿…è¨˜ä½ç¬¬ä¸‰çµ„å¯†ç¢¼</p>
                <!-- ç§»é™¤å…¶ä»–æç¤ºæ–‡å­— -->
                
                <!-- æ ¹æ“šä½¿ç”¨è€…è¦æ±‚ä¿®æ”¹æŒ‰éˆ•æ–‡å­— -->
                <button onclick="showPasswordView()" class="mt-8 flex items-center space-x-2 px-8 py-3 bg-indigo-600 text-white font-bold text-lg rounded-full shadow-lg hover:bg-indigo-700 transition duration-200">
                    <i data-lucide="lock-keyhole" class="w-6 h-6"></i>
                    <span>æˆ‘çŸ¥é“äº†ï¼Œä¸‹ä¸€æ­¥</span>
                </button>
            </div>
        </div>

        <!-- 5. å¯†ç¢¼è¼¸å…¥ (Password View) - é©ç”¨æ–¼å››äº”å…­å¹´ç´š -->
        <div id="passwordView" class="view hidden">
            <h2 class="text-2xl font-semibold text-gray-700 mb-6 text-center">æ­¥é©Ÿ 3ï¼šè¼¸å…¥é€šé—œå¯†ç¢¼ (å››ä½æ•¸)</h2>
            <div class="bg-yellow-50 p-6 rounded-xl shadow-lg border-4 border-yellow-300 flex flex-col items-center max-w-sm mx-auto">
                <!-- æ ¹æ“šä½¿ç”¨è€…è¦æ±‚ä¿®æ”¹æç¤ºè© -->
                <p class="text-base font-medium text-yellow-800 mb-4 text-center">
                    è«‹å°‡ä¸‰çµ„æ•¸å­—ï¼Œè¦–ç‚ºå­—ä¸²çµ„åˆèµ·ä¾†å°±æ˜¯é€šé—œå¯†ç¢¼(æç¤ºï¼šç¸½å…±4ç¢¼æ•¸å­—)
                </p>
                <!-- ç§»é™¤æ ¼å¼æç¤º -->

                <input type="number" id="passwordInput" placeholder="è«‹è¼¸å…¥ 4 ä½æ•¸å¯†ç¢¼"
                       maxlength="4" oninput="if(this.value.length > this.maxLength) this.value = this.value.slice(0, this.maxLength);"
                       class="w-full text-center text-4xl font-mono px-4 py-3 border-4 border-indigo-400 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 shadow-inner">

                <p id="passwordError" class="mt-3 text-red-600 font-semibold hidden">å¯†ç¢¼éŒ¯èª¤ï¼Œè«‹å†è©¦ä¸€æ¬¡ï¼</p>

                <button onclick="checkPassword()" class="w-full mt-6 flex items-center justify-center space-x-2 px-8 py-3 bg-green-600 text-white font-bold text-lg rounded-full shadow-lg hover:bg-green-700 transition duration-200">
                    <i data-lucide="unlock" class="w-6 h-6"></i>
                    <span>é©—è­‰å¯†ç¢¼ä¸¦å•Ÿå‹•ç›¸æ©Ÿ</span>
                </button>
            </div>
            <div class="flex justify-center mt-6">
                <button onclick="showQuizAnniversaryView()" class="flex items-center space-x-2 px-6 py-2 bg-gray-200 text-gray-700 font-semibold rounded-full hover:bg-gray-300 transition duration-200">
                    <i data-lucide="arrow-left" class="w-5 h-5"></i>
                    <span>è¿”å›å•ç­”ä¸‰</span>
                </button>
            </div>
        </div>

        <!-- 6. ç›¸æ©Ÿæ‹æ” (Camera View) -->
        <div id="cameraView" class="view hidden">
            <h2 class="text-2xl font-semibold text-gray-700 mb-6 text-center">æ­¥é©Ÿ 4ï¼šå•Ÿå‹•ç›¸æ©Ÿä¸¦æ‹æ”</h2>
            <div class="relative w-full aspect-video bg-gray-800 rounded-xl overflow-hidden shadow-lg mb-6">
                <video id="webcamVideo" class="w-full h-full object-cover" autoplay playsinline></video>
                <div id="loadingCamera" class="absolute inset-0 flex items-center justify-center bg-gray-900/80 text-white text-lg hidden">
                    <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    æ­£åœ¨è¼‰å…¥ç›¸æ©Ÿ...
                </div>
            </div>
            <div class="flex justify-center space-x-4">
                <button id="captureBtn" onclick="captureAndSynthesize()" class="flex items-center space-x-2 px-8 py-3 bg-red-500 text-white font-bold text-lg rounded-full shadow-lg hover:bg-red-600 transition duration-200 disabled:bg-gray-400" disabled>
                    <i data-lucide="camera" class="w-6 h-6"></i>
                    <span>æ‹ç…§ï¼</span>
                </button>
                <button onclick="stopCamera(); showView('menuView')" class="flex items-center space-x-2 px-6 py-3 bg-gray-200 text-gray-700 font-semibold rounded-full hover:bg-gray-300 transition duration-200">
                    <i data-lucide="x" class="w-6 h-6"></i>
                    <span>å–æ¶ˆ</span>
                </button>
            </div>
            <canvas id="photoCanvas" class="hidden"></canvas>
        </div>

        <!-- 7. åˆæˆçµæœ (Result View) -->
        <div id="resultView" class="view hidden">
            <h2 class="text-2xl font-semibold text-gray-700 mb-6 text-center">æ­¥é©Ÿ 5ï¼šåˆæˆçµæœ</h2>
            <div class="flex flex-col items-center">
                <canvas id="synthesisCanvas" class="w-full max-w-lg aspect-video rounded-xl shadow-2xl border-4 border-indigo-400"></canvas>
                <div id="loadingSynthesis" class="flex flex-col items-center justify-center mt-4 text-indigo-600 text-lg hidden p-4">
                    <svg class="animate-spin h-8 w-8 text-indigo-500 mb-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    æ­£åœ¨ä½¿ç”¨ Nano Banana é€²è¡Œæ™ºæ…§åˆæˆ...
                    <p class="text-sm text-gray-500 mt-1">é€™å¯èƒ½éœ€è¦å¹¾ç§’é˜</p>
                </div>

                <!-- æ–°å¢ï¼šé›»å­éƒµä»¶å¯„é€è¡¨å–® (åƒ… 1-3 å¹´ç´šé¡¯ç¤º) -->
                <div id="emailFormContainer" class="w-full max-w-sm mt-8 p-6 bg-blue-50 rounded-xl shadow-inner border border-blue-200 hidden">
                    <p class="text-lg font-semibold text-blue-800 mb-4 text-center">ğŸ‰ ç…§ç‰‡å·²åˆæˆï¼</p>
                    <p class="text-sm text-gray-700 mb-3 text-center">è«‹è¼¸å…¥æ‚¨çš„å¸³è™Ÿï¼Œå°‡ç…§ç‰‡å¯„åˆ°æ‚¨çš„ä¿¡ç®±ä¸¦å‚™ä»½è‡³é›²ç«¯ç¡¬ç¢Ÿï¼š</p>

                    <div class="flex">
                        <input type="text" id="emailAccountInput" placeholder="è«‹è¼¸å…¥å¸³è™Ÿ (ä¾‹å¦‚ï¼šA12345)"
                               class="flex-grow px-4 py-2 border border-blue-400 rounded-l-lg focus:ring-blue-500 focus:border-blue-500">
                        <span class="px-3 py-2 bg-blue-100 border border-blue-400 border-l-0 text-blue-700 font-medium rounded-r-lg">@chc.edu.tw</span>
                    </div>

                    <button id="sendEmailBtn" onclick="sendEmail()"
                            class="w-full mt-4 flex items-center justify-center space-x-2 px-6 py-2 bg-blue-600 text-white font-bold rounded-full hover:bg-blue-700 transition duration-200 shadow-md disabled:bg-gray-400">
                        <i data-lucide="mail" class="w-5 h-5"></i>
                        <span>å¯„é€ç…§ç‰‡ä¸¦å‚™ä»½</span>
                    </button>

                    <p id="emailMessage" class="mt-3 text-center text-sm font-medium hidden"></p>
                </div>
                <!-- çµæŸï¼šé›»å­éƒµä»¶å¯„é€è¡¨å–® -->

                <div class="flex justify-center space-x-4 mt-6">
                    <a id="downloadLink" download="ç§‘ä¸ç›¸ç°¿_åˆæˆç…§.png" class="flex items-center space-x-2 px-6 py-2 bg-green-500 text-white font-bold rounded-full hover:bg-green-600 transition duration-200 shadow-md">
                        <i data-lucide="download" class="w-5 h-5"></i>
                        <span>ä¸‹è¼‰ç…§ç‰‡</span>
                    </a>
                    <button onclick="showView('menuView')" class="flex items-center space-x-2 px-6 py-2 bg-indigo-500 text-white font-bold rounded-full hover:bg-indigo-600 transition duration-200 shadow-md">
                        <i data-lucide="refresh-cw" class="w-5 h-5"></i>
                        <span>é‡æ–°é–‹å§‹</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // ----------------------------------------------------------------------
        // 1. Firebase Boilerplate (Required but not used for this local app)
        // ----------------------------------------------------------------------
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase configuration and initialization (MANDATORY BOILERPLATE)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, db, auth;
        if (firebaseConfig) {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            setLogLevel('Debug');

            // Sign in process
            if (initialAuthToken) {
                signInWithCustomToken(auth, initialAuthToken).catch(error => {
                    console.error("Firebase custom token sign-in failed:", error);
                    signInAnonymously(auth).catch(err => console.error("Anonymous sign-in failed:", err));
                });
            } else {
                signInAnonymously(auth).catch(error => {
                    console.error("Firebase anonymous sign-in failed:", error);
                });
            }
        }
        // End of Firebase Boilerplate

        // ----------------------------------------------------------------------
        // ã€â— å¿…å¡«è¨­å®š â—ã€‘
        // 1. è«‹å°‡æ­¤è™•æ›¿æ›ç‚ºæ‚¨éƒ¨ç½² GAS Web App å¾Œå–å¾—çš„åŸ·è¡Œ URLã€‚
        // 2. å¤–éƒ¨è¨—ç®¡æ™‚ï¼Œè«‹è¨˜å¾—æ›¿æ› apiKeyã€‚
        // ----------------------------------------------------------------------
        const GAS_WEB_APP_URL = "https://script.google.com/macros/s/AKfycbx3guSQnG-9KWexIxck2FiPzEWrEvqcFfaBg_5rS9OzB6MeQpOyDRqCx7nYYpYgy6Or/exec"; 


        // ----------------------------------------------------------------------
        // 2. æ‡‰ç”¨ç¨‹å¼è³‡æ–™èˆ‡ç‹€æ…‹ (App Data and State)
        // ----------------------------------------------------------------------

        // æ‰€æœ‰çš„å ´æ™¯åœ–ç‰‡ URL (èˆ‡é¸é …æ•¸å­— 1-7 å°æ‡‰) - å·²æ›´æ–°
        const ALL_SCENES_DATA = [
            { index: 1, name: "IMG_0048.JPG", id: "1GWNJw3E0mSuDXT6Di3WjURi22aaqbtmy", url: "https://lh3.googleusercontent.com/d/1GWNJw3E0mSuDXT6Di3WjURi22aaqbtmy", location_name: "å ´æ™¯ä¸€" },
            { index: 2, name: "IMG_0044.JPG", id: "1xajcbigEnnDgKOiwJIq3mSluBVOYA77b", url: "https://lh3.googleusercontent.com/d/1xajcbigEnnDgKOiwJIq3mSluBVOYA77b", location_name: "å ´æ™¯äºŒ" },
            { index: 3, name: "IMG_0061.JPG", id: "1SNaXlHToWku9GZpmr_KkuLshEe6AVaH5", url: "https://lh3.googleusercontent.com/d/1SNaXlHToWku9GZpmr_KkuLshEe6AVaH5", location_name: "å ´æ™¯ä¸‰" },
            { index: 4, name: "IMG_0062.JPG", id: "1sORMgxpPsBl5mvzhfPYHoh6DHxoW7G1C", url: "https://lh3.googleusercontent.com/d/1sORMgxpPsBl5mvzhfPYHoh6DHxoW7G1C", location_name: "å ´æ™¯å››" },
            { index: 5, name: "IMG_0057.JPG", id: "1J9D5ydZfpTN75og8yGWjRtPgd7wuDdcm", url: "https://lh3.googleusercontent.com/d/1J9D5ydZfpTN75og8yGWjRtPgd7wuDdcm", location_name: "å ´æ™¯äº”" },
            { index: 6, name: "IMG_0054.JPG", id: "1I9cLp6plVSccUMchyEnLVH8C93mEprzR", url: "https://lh3.googleusercontent.com/d/1I9cLp6plVSccUMchyEnLVH8C93mEprzR", location_name: "å ´æ™¯å…­" },
            { index: 7, name: "IMG_0053.JPG", id: "1d_zSKJj_0IHN5x37GSxj3psCBNx_tDi6", url: "https://lh3.googleusercontent.com/d/1d_zSKJj_0IHN5x37GSxj3psCBNx_tDi6", location_name: "å ´æ™¯ä¸ƒ" }
        ];

        // å¯é¸é¢¨æ ¼åŠå…¶å°æ‡‰çš„æç¤ºè©ä¿®æ”¹å™¨ (èˆ‡é¸é …æ•¸å­— 1-7 å°æ‡‰) - å·²æ›´æ–°æ¼«å¨é¢¨æ ¼
        const STYLES = [
            { index: 1, id: 'none', name: 'ä¸åˆæˆ', prompt: 'a realistic photo without any style modification. Do not apply any filters or cartoon effects to the figure.', sampleUrl: "https://lh3.googleusercontent.com/d/1o4HP5YWSoAH7czhWd3B9EWNfWStB8uQ4" },
            // ------------------------------------------------------------------
            // ** æ ¹æ“šä½¿ç”¨è€…è¦æ±‚æ›´æ–° sampleUrl **
            { index: 2, id: 'comic', name: 'æ¼«å¨é¢¨æ ¼', prompt: 'a bold, dynamic superhero comic book style, high contrast, vibrant colors, inspired by Marvel comics.', sampleUrl: "https://lh3.googleusercontent.com/d/1-ZztaacyJUggBzZ7al33BJEzfGng3Xcc" },
            // ------------------------------------------------------------------
            { index: 3, id: 'anime', name: 'æ—¥æ¼«é¢¨æ ¼', prompt: 'a high-quality Japanese anime style (cartoon) inspired by Studio Ghibli, featuring lush backgrounds and soft color palettes.', sampleUrl: "https://lh3.googleusercontent.com/d/1-ZztaacyJUggBzZ7al33BJEzfGng3Xcc" },
            { index: 4, id: 'chibi', name: 'Qç‰ˆå¡é€š', prompt: 'a cute chibi, large-head, small-body cartoon style, full body.', sampleUrl: "https://lh3.googleusercontent.com/d/1yF6D1zz5AQANB-Z7jwj-DCuFmXdr4RHk" },
            { index: 5, id: 'abstract', name: 'æŠ½è±¡æ´¾', prompt: 'an abstract painting style in the manner of Picasso (Cubism), expressive colors and forms.', sampleUrl: "https://lh3.googleusercontent.com/d/1Ayh6srtrdyuSQlK4tOrKgODG_edn3vyv" },
            { index: 6, id: 'popart', name: 'æ™®æ™®é¢¨', prompt: 'a bold, graphic print in the Pop Art style (Andy Warhol/Roy Lichtenstein), with thick outlines and flat colors.', sampleUrl: "https://lh3.googleusercontent.com/d/1iJEc1fGL3F4jM5V72bRc1MTEbBphy2lr" },
            { index: 7, id: 'pixel', name: 'é»é™£åœ–é¢¨æ ¼', prompt: 'low-resolution 8-bit pixel art style, simplified colors, high contrast, full body shot.', sampleUrl: "https://lh3.googleusercontent.com/d/1p-HL2EYU4mpkb2KF6UWB8rc40f-w82wU" }
        ];

        // ç‹€æ…‹è®Šæ•¸
        let selectedSceneUrl = null;
        let selectedStylePrompt = null;
        let cameraStream = null;

        window.currentGrade = null; // ç´€éŒ„ç•¶å‰é¸æ“‡çš„å¹´ç´š

        // 4-6 grade password state
        window.firstDigit = null;  // Digit 1 (Scene 1-7)
        window.secondDigit = null; // Digit 2 (Style 1-7)
        const ANNIVERSARY_DIGITS = "22"; // Digits 3 & 4 (æ ¡æ…¶é€±å¹´å¯†ç¢¼)

        // ----------------------------------------------------------------------
        // 3. ç•«é¢åˆ‡æ›èˆ‡å°èˆª (View Switching and Navigation)
        // ----------------------------------------------------------------------

        /**
         * é¡¯ç¤ºæŒ‡å®šçš„ç•«é¢ä¸¦éš±è—å…¶ä»–ç•«é¢
         * @param {string} viewName - è¦é¡¯ç¤ºçš„ç•«é¢ ID
         */
        window.showView = (viewName) => {
            document.querySelectorAll('.view').forEach(view => {
                view.classList.add('hidden');
            });
            document.getElementById(viewName).classList.remove('hidden');

            if (viewName !== 'cameraView' && cameraStream) {
                window.stopCamera();
            }
            // æ¯æ¬¡åˆ‡æ›ç•«é¢æ™‚ï¼Œé‡æ–°æ¸²æŸ“ icon
            lucide.createIcons();
        };

        /**
         * æ ¹æ“šå¹´ç´šå•Ÿå‹•å°æ‡‰æµç¨‹
         * @param {string} grade - å¹´ç´šä»£è™Ÿ ('1-3' or '4-6')
         */
        window.startGradeFlow = (grade) => {
            window.currentGrade = grade;

            if (grade === '4-6') {
                showQuizSceneView(); // é€²å…¥å•ç­”ä¸€
                return;
            }

            // 1-3 grade logic: Show scene selection
            showView('sceneSelectionView');
            const container = document.getElementById('scenesContainer');

            // 1-3 å¹´ç´šä½¿ç”¨ ALL_SCENES_DATA é€²è¡Œé¸å–
            container.innerHTML = ALL_SCENES_DATA.map((scene, index) => `
                <div onclick="selectScene('${scene.url}')" id="scene-${index}"
                     class="scene-item flex-shrink-0 w-36 h-24 md:w-44 md:h-32
                            bg-gray-200 rounded-lg overflow-hidden cursor-pointer
                            shadow-md hover:shadow-xl transition duration-300 border-4 border-transparent ${selectedSceneUrl === scene.url ? 'border-indigo-500' : 'hover:border-indigo-500'}">
                    <!-- ä½¿ç”¨æ›´æ–°å¾Œçš„ scene.url é€²è¡Œé¡¯ç¤º -->
                    <img src="${scene.url}" 
                         onerror="this.src='https://placehold.co/176x128/ccc/333?text=å ´æ™¯${scene.index}_è¼‰å…¥å¤±æ•—';"
                         class="w-full h-full object-cover" alt="${scene.location_name}">
                    <p class="text-xs text-center p-1 bg-gray-700 text-white truncate">${scene.location_name}</p>
                </div>
            `).join('');
        };

        /**
         * é¡¯ç¤ºæ ¡åœ’å•ç­”ä¸€ (å ´æ™¯é¸æ“‡) ç•«é¢ (ç”¨æ–¼ 4-6 å¹´ç´š)
         */
        function showQuizSceneView() {
            showView('quizSceneView');
            const container = document.getElementById('quizSceneOptionsContainer');

            container.innerHTML = ALL_SCENES_DATA.map((scene) => `
                <button onclick="selectQuizAnswerScene(${scene.index}, '${scene.url}')"
                        class="quiz-option-btn w-full px-6 py-3 bg-white border border-indigo-400 text-indigo-600
                               font-semibold text-lg rounded-xl shadow hover:bg-indigo-50 hover:shadow-md
                               transition duration-200 text-left">
                    é¸é … ${scene.index}: ${scene.location_name}
                </button>
            `).join('');
        }

        /**
         * è™•ç†å•ç­”ä¸€çµæœ (å ´æ™¯é¸æ“‡)ï¼Œå„²å­˜ç¬¬ä¸€å€‹æ•¸å­—
         */
        window.selectQuizAnswerScene = (selectedIndex, sceneUrl) => {
            window.firstDigit = selectedIndex;
            selectedSceneUrl = sceneUrl;
            showMemorySceneView(selectedIndex);
        };

        /**
         * é¡¯ç¤ºè¨˜æ†¶æç¤ºç•«é¢ä¸€ (Memory 1: Scene Digit)
         */
        function showMemorySceneView(selectedIndex) {
            showView('memorySceneView');
            document.getElementById('memorySceneNumberContainer').textContent = selectedIndex;
        }

        /**
         * é¡¯ç¤ºæ ¡åœ’å•ç­”äºŒ (é¢¨æ ¼é¸æ“‡) ç•«é¢ (ç”¨æ–¼ 4-6 å¹´ç´š)
         */
        window.showQuizStyleView = () => {
            showView('quizStyleView');
            const container = document.getElementById('quizStyleOptionsContainer');

            container.innerHTML = STYLES.map((style) => `
                <button onclick="selectQuizAnswerStyle(${style.index}, '${style.prompt}')"
                        class="quiz-option-btn w-full px-6 py-3 bg-white border border-purple-400 text-purple-600
                               font-semibold text-lg rounded-xl shadow hover:bg-purple-50 hover:shadow-md
                               transition duration-200 text-left">
                    é¸é … ${style.index}: ${style.name}
                </button>
            `).join('');
        }

        /**
         * è™•ç†å•ç­”äºŒçµæœ (é¢¨æ ¼é¸æ“‡)ï¼Œå„²å­˜ç¬¬äºŒå€‹æ•¸å­—
         */
        window.selectQuizAnswerStyle = (selectedIndex, stylePrompt) => {
            window.secondDigit = selectedIndex;
            selectedStylePrompt = stylePrompt;
            showMemoryStyleView(selectedIndex);
        };

        /**
         * é¡¯ç¤ºè¨˜æ†¶æç¤ºç•«é¢äºŒ (Memory 2: Style Digit)
         */
        function showMemoryStyleView(selectedIndex) {
            showView('memoryStyleView');
            document.getElementById('memoryStyleNumberContainer').textContent = selectedIndex;
        }

        /**
         * é¡¯ç¤ºæ ¡åœ’å•ç­”ä¸‰ (æ ¡æ…¶é€±å¹´) ç•«é¢ (ç”¨æ–¼ 4-6 å¹´ç´š)
         */
        window.showQuizAnniversaryView = () => {
            showView('quizAnniversaryView');
        }

        /**
         * é¡¯ç¤ºå¯†ç¢¼è¼¸å…¥ç•«é¢ (ç”¨æ–¼ 4-6 å¹´ç´š)
         */
        window.showPasswordView = () => {
            showView('passwordView');
            document.getElementById('passwordError').classList.add('hidden');
            document.getElementById('passwordInput').value = '';
        }

        /**
         * é©—è­‰é€šé—œå¯†ç¢¼ (ç”¨æ–¼ 4-6 å¹´ç´š)
         */
        window.checkPassword = () => {
            const inputElement = document.getElementById('passwordInput');
            const errorElement = document.getElementById('passwordError');

            const enteredPassword = inputElement.value.trim();
            // çµ„åˆä¸‰çµ„æ•¸å­—ï¼š[å ´æ™¯æ•¸å­—] [é¢¨æ ¼æ•¸å­—] [æ ¡æ…¶æ•¸å­— (22)]
            const correctPassword = `${window.firstDigit}${window.secondDigit}${ANNIVERSARY_DIGITS}`;

            if (enteredPassword === correctPassword) {
                // å¯†ç¢¼æ­£ç¢ºï¼Œå•Ÿå‹•ç›¸æ©Ÿæµç¨‹
                errorElement.classList.add('hidden');
                startCamera();
                showView('cameraView');
            } else {
                // å¯†ç¢¼éŒ¯èª¤
                errorElement.classList.remove('hidden');
                console.log(`å¯†ç¢¼éŒ¯èª¤ï¼æ­£ç¢ºå¯†ç¢¼æ‡‰ç‚º ${correctPassword} (è«‹å‹¿å‘Šè¨´ä½¿ç”¨è€…)`);
            }
        }

        /**
         * é¸æ“‡å ´æ™¯åœ–ç‰‡ä¸¦åˆ‡æ›åˆ°é¢¨æ ¼é¸æ“‡ç•«é¢ (åƒ…ç”¨æ–¼ 1-3 å¹´ç´š)
         * @param {string} url - é¸å®šçš„å ´æ™¯åœ–ç‰‡ URL
         */
        window.selectScene = (url) => {
            selectedSceneUrl = url;

            // è¦–è¦ºä¸Šæ¨™è¨˜é¸ä¸­çš„å ´æ™¯
            document.querySelectorAll('.scene-item').forEach(item => {
                item.classList.remove('border-indigo-500');
            });
            event.currentTarget.classList.add('border-indigo-500');

            // å»¶é²åˆ‡æ›åˆ°é¢¨æ ¼é¸æ“‡ç•«é¢
            setTimeout(() => {
                window.loadStyleSelectionForGrade1_3(); // ä½¿ç”¨ window. å‘¼å«
                showView('styleSelectionView');
            }, 300);
        };

        /**
         * è¼‰å…¥é¢¨æ ¼é¸æ“‡ç•«é¢ (ä½¿ç”¨ç¯„ä¾‹åœ–ç‰‡) - åƒ…ä¾› 1-3 å¹´ç´šä½¿ç”¨
         */
        window.loadStyleSelectionForGrade1_3 = () => { // ä¿®æ­£ï¼šç¢ºä¿åœ¨å…¨åŸŸç¯„åœå…§å®šç¾©
            const container = document.getElementById('stylesContainer');

            container.innerHTML = STYLES.map(style => `
                <div onclick="selectStyleForGrade1_3('${style.id}')" id="style-${style.id}"
                     class="style-card flex flex-col items-center p-2
                            bg-white rounded-xl cursor-pointer transition duration-200
                            shadow-lg hover:shadow-xl border-4 border-transparent
                            w-32 h-44 md:w-40 md:h-52 overflow-hidden
                            ${selectedStylePrompt === style.prompt ? 'border-red-500 bg-red-50' : 'hover:border-indigo-500'}">
                    <div class="w-full aspect-square overflow-hidden rounded-lg mb-2">
                        <!-- ç¯„ä¾‹åœ–ç‰‡ -->
                        <img src="${style.sampleUrl}"
                             onerror="this.src='https://placehold.co/160x160/ccc/333?text=ç„¡ç¯„ä¾‹åœ–';"
                             alt="${style.name} ç¯„ä¾‹åœ–"
                             class="w-full h-full object-cover transform transition duration-300 hover:scale-105"
                        >
                    </div>
                    <span class="text-sm font-bold text-center text-gray-700">${style.name}</span>
                </div>
            `).join('');
        };

        /**
         * é¸æ“‡é¢¨æ ¼ä¸¦åˆ‡æ›åˆ°ç›¸æ©Ÿç•«é¢ (åƒ…ç”¨æ–¼ 1-3 å¹´ç´š)
         * @param {string} styleId - é¸å®šçš„é¢¨æ ¼ ID
         */
        window.selectStyleForGrade1_3 = (styleId) => {
            const style = STYLES.find(s => s.id === styleId);
            selectedStylePrompt = style ? style.prompt : STYLES[0].prompt; // ç¢ºä¿æœ‰é è¨­å€¼

            // è¦–è¦ºä¸Šæ¨™è¨˜é¸ä¸­çš„é¢¨æ ¼
            document.querySelectorAll('.style-card').forEach(item => {
                item.classList.remove('border-red-500', 'bg-red-50');
                item.classList.add('hover:border-indigo-500');
            });
            event.currentTarget.classList.add('border-red-500', 'bg-red-50');

            // å»¶é²åˆ‡æ›åˆ°ç›¸æ©Ÿç•«é¢
            setTimeout(() => {
                startCamera();
                showView('cameraView');
            }, 300);
        };

        // ----------------------------------------------------------------------
        // 4. ç›¸æ©Ÿæ“ä½œ (Camera Operations)
        // ----------------------------------------------------------------------

        /**
         * å•Ÿå‹•ç¶²è·¯æ”å½±æ©Ÿ
         */
        async function startCamera() {
            const video = document.getElementById('webcamVideo');
            const loading = document.getElementById('loadingCamera');
            const captureBtn = document.getElementById('captureBtn');

            captureBtn.disabled = true;
            loading.classList.remove('hidden');

            try {
                // å˜—è©¦å–å¾—å‰ç½®æ”å½±æ©Ÿ (user)ï¼Œè‹¥å¤±æ•—å‰‡å–å¾—å¾Œç½®/é è¨­ (environment)
                cameraStream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: "user" },
                    audio: false
                });
                video.srcObject = cameraStream;
                await video.play();

                captureBtn.disabled = false;
                loading.classList.add('hidden');
            } catch (err) {
                console.error("ç„¡æ³•å­˜å–ç›¸æ©Ÿ:", err);
                loading.innerHTML = 'ç„¡æ³•å­˜å–ç›¸æ©Ÿï¼Œè«‹æª¢æŸ¥æ¬Šé™ã€‚';
            }
        }

        /**
         * åœæ­¢ç¶²è·¯æ”å½±æ©Ÿ
         */
        window.stopCamera = ( ) => {
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
                const video = document.getElementById('webcamVideo');
                video.srcObject = null;
            }
        };

        // ----------------------------------------------------------------------
        // 5. åœ–åƒè™•ç†èˆ‡åˆæˆ (Image Processing and Synthesis - Using Nano Banana)
        // ----------------------------------------------------------------------

        /**
         * è½‰æ› Data URL ç‚ºç´” Base64 å­—ä¸²
         */
        function dataUrlToPureBase64(dataUrl) {
            return dataUrl.split(',')[1];
        }

        /**
         * è¼‰å…¥å¤–éƒ¨ URL åœ–ç‰‡ä¸¦å›å‚³ Base64 å­—ä¸² (ä¿®æ­£ 'Failed to fetch' éŒ¯èª¤)
         * æ–°æ–¹æ³•ï¼šä½¿ç”¨ Image å…ƒç´ å’Œ Canvas ç¹é fetch é™åˆ¶ï¼Œä¸¦è¨­å®š crossOrigin è§£æ±º Tainted Canvas å•é¡Œ
         * @param {string} url - åœ–ç‰‡çš„ lh3.googleusercontent.com URL
         */
        async function loadUrlAsBase64(url) {
            const img = new Image();
            // é—œéµï¼šè¨­ç½® crossOrigin å±¬æ€§ä»¥å…è¨±åœ¨ Canvas ä¸Šè®€å–åœ–åƒè³‡æ–™ï¼Œé¿å… Tainted Canvas éŒ¯èª¤
            img.crossOrigin = 'Anonymous'; 

            for (let attempt = 0; attempt < 3; attempt++) {
                try {
                    const base64Data = await new Promise((resolve, reject) => {
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            canvas.width = img.naturalWidth;
                            canvas.height = img.naturalHeight;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0);
                            
                            try {
                                const dataUrl = canvas.toDataURL('image/png');
                                // æˆåŠŸå¾Œï¼Œç§»é™¤ Data URL å‰ç¶´
                                resolve(dataUrlToPureBase64(dataUrl));
                            } catch (e) {
                                // å¦‚æœ canvas ä»ç„¶è¢«æ¨™è¨˜ç‚º tainted (ä¾‹å¦‚ï¼Œåœ–ç‰‡æœªè¨­ç‚ºå…¬é–‹åˆ†äº«)ï¼Œé€™æœƒæ•ç²éŒ¯èª¤
                                // é€™è£¡å‡è¨­åœ–ç‰‡å·²ç¶“æ­£ç¢ºè¨­ç½®ç‚ºå…¬é–‹åˆ†äº«
                                reject(new Error(`Failed to export canvas data. Please ensure the image is publicly accessible and supports CORS. Original error: ${e.message}`));
                            }
                        };
                        
                        img.onerror = (e) => {
                            // åœ–ç‰‡è¼‰å…¥å¤±æ•— (e.g. 404, network error, or Google blocking direct image access)
                            reject(new Error(`åœ–ç‰‡è¼‰å…¥å¤±æ•— (Image onerror event). URL: ${url}`));
                        };

                        // ä½¿ç”¨ lh3.googleusercontent.com çš„ URL è¼‰å…¥åœ–ç‰‡
                        img.src = url;
                    });
                    
                    return base64Data; // æˆåŠŸå›å‚³ Base64
                } catch (error) {
                    if (attempt === 2) {
                        console.error(`Attempt ${attempt + 1} to load image failed (final):`, url, error);
                        throw new Error(`Failed to load background image after 3 attempts. ${error.message}`);
                    }
                    console.warn(`Attempt ${attempt + 1} to load image failed. Retrying in ${Math.pow(2, attempt) * 1000}ms.`, url, error);
                    await new Promise(r => setTimeout(r, Math.pow(2, attempt) * 1000));
                }
            }
        }


        /**
         * ä½¿ç”¨ gemini-2.5-flash-image-preview (Nano Banana) é€²è¡Œåœ–åƒè™•ç†èˆ‡åˆæˆ
         */
        async function generateImageWithNanoBanana(capturedBase64, backgroundBase64) {
            const apiKey = "AIzaSyAybszLoDU5JJVylGUAZtRe8yPgu0WVECw"; // Canvas åŸ·è¡Œæ™‚æœƒè‡ªå‹•æä¾›ï¼Œå¤–éƒ¨è¨—ç®¡éœ€æ‰‹å‹•å¡«å¯«
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent?key=${apiKey}`;
            const synthesisCanvas = document.getElementById('synthesisCanvas');
            const loading = document.getElementById('loadingSynthesis');
            const downloadLink = document.getElementById('downloadLink');

            // åŸºç¤æç¤ºè©ï¼šè¦æ±‚æ¨¡å‹å°‡äººç‰©å»èƒŒã€è½‰æ›é¢¨æ ¼å¾Œï¼Œç–ŠåŠ åˆ°èƒŒæ™¯åœ–ä¸Š
            const basePrompt = "Convert the person in the first image (captured via webcam) into [STYLE_PROMPT_HERE]. Remove the background of the resulting figure. The rendered figure MUST be a half-body shot (from the waist up), scaled to occupy approximately 1/4 of the overall canvas area, and placed near the bottom or side of the composite image. Ensure the figure maintains naturally slim body proportions, avoiding any appearance of excessive muscle mass or bulkiness. Combine the processed figure with the second image (the background scene) to create a single composite photo.";

            const fullPrompt = basePrompt.replace('[STYLE_PROMPT_HERE]', selectedStylePrompt);

            console.log("Using Synthesis Prompt:", fullPrompt);

            const payload = {
                contents: [{
                    role: "user",
                    parts: [
                        { text: fullPrompt },
                        { inlineData: { mimeType: "image/png", data: capturedBase64 } },
                        { inlineData: { mimeType: "image/jpeg", data: backgroundBase64 } }
                    ]
                }],
                generationConfig: {
                    responseModalities: ['TEXT', 'IMAGE']
                }
            };

            downloadLink.classList.remove('pointer-events-none', 'opacity-50');

            for (let attempt = 0; attempt < 3; attempt++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const errorBody = await response.text();
                        console.error(`API attempt ${attempt + 1} failed with status ${response.status}:`, errorBody);
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const result = await response.json();
                    const base64Data = result?.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData?.data;

                    if (!base64Data) {
                        console.error("API response missing image data:", result);
                        throw new Error("Failed to receive image data from API.");
                    }

                    const imageUrl = `data:image/png;base64,${base64Data}`;
                    
                    // ä½¿ç”¨ new Image() ä¾†è¼‰å…¥ Base64 Data URL
                    const generatedImg = await new Promise((resolve, reject) => {
                        const img = new Image();
                        img.onload = () => resolve(img);
                        img.onerror = () => reject(new Error("Generated image failed to load."));
                        img.src = imageUrl;
                    });


                    const ctx = synthesisCanvas.getContext('2d');
                    synthesisCanvas.width = generatedImg.width;
                    synthesisCanvas.height = generatedImg.height;
                    ctx.drawImage(generatedImg, 0, 0);

                    loading.classList.add('hidden');
                    synthesisCanvas.classList.remove('hidden');
                    downloadLink.href = imageUrl;

                    // 1-3 å¹´ç´šé¡¯ç¤ºå¯„ä¿¡è¡¨å–®ï¼Œ4-6 å¹´ç´šéš±è—
                    if (window.currentGrade === '1-3') {
                        document.getElementById('emailFormContainer').classList.remove('hidden');
                    } else {
                        document.getElementById('emailFormContainer').classList.add('hidden');
                    }

                    return; // æˆåŠŸ
                } catch (error) {
                    console.error(`Attempt ${attempt + 1} failed:`, error);
                    if (attempt < 2) {
                        await new Promise(resolve => setTimeout(resolve, Math.pow(2, attempt) * 1000));
                    } else {
                        loading.classList.add('hidden');
                        synthesisCanvas.classList.remove('hidden');
                        const ctx = synthesisCanvas.getContext('2d');
                        synthesisCanvas.width = 800;
                        synthesisCanvas.height = 450;
                        ctx.fillStyle = '#fef2f2';
                        ctx.fillRect(0, 0, 800, 450);
                        ctx.fillStyle = '#b91c1c';
                        ctx.font = '20px Inter, sans-serif';
                        ctx.textAlign = 'center';
                        ctx.fillText('åˆæˆå¤±æ•—ï¼šç„¡æ³•é€£æ¥è‡³ Nano Banana æ¨¡å‹æˆ–è™•ç†è«‹æ±‚ã€‚', 400, 225);

                        document.getElementById('emailFormContainer').classList.add('hidden');
                        downloadLink.href = '#';
                        downloadLink.classList.add('pointer-events-none', 'opacity-50');

                        return;
                    }
                }
            }
        }

        /**
         * æ‹ç…§ä¸¦é€²è¡Œåˆæˆ
         */
        window.captureAndSynthesize = async () => {
            const video = document.getElementById('webcamVideo');
            const photoCanvas = document.getElementById('photoCanvas');

            if (video.readyState !== 4) return;
            if (!selectedStylePrompt || !selectedSceneUrl) {
                console.error('è«‹å…ˆé¸æ“‡å ´æ™¯å’Œé¢¨æ ¼ï¼');
                return;
            }

            // 1. æ‹æ”ç…§ç‰‡ (Video to Canvas)
            const videoWidth = video.videoWidth;
            const videoHeight = video.videoHeight;
            const targetSize = 300;
            photoCanvas.width = targetSize;
            photoCanvas.height = targetSize;

            const photoCtx = photoCanvas.getContext('2d');
            photoCtx.drawImage(video, 0, 0, videoWidth, videoHeight, 0, 0, targetSize, targetSize);

            const capturedDataUrl = photoCanvas.toDataURL('image/png');

            // é¡¯ç¤ºåˆæˆè¼‰å…¥ä¸­
            showView('resultView');
            document.getElementById('synthesisCanvas').classList.add('hidden');
            document.getElementById('loadingSynthesis').classList.remove('hidden');
            document.getElementById('emailFormContainer').classList.add('hidden');

            window.stopCamera(); // åœæ­¢ç›¸æ©Ÿ

            try {
                // 2. è¼‰å…¥èƒŒæ™¯åœ–çš„ Base64 æ•¸æ“š (ä½¿ç”¨ Image + Canvas é‚è¼¯)
                const backgroundBase64 = await loadUrlAsBase64(selectedSceneUrl);
                const capturedBase64 = dataUrlToPureBase64(capturedDataUrl);

                // 3. å‘¼å« Nano Banana API é€²è¡Œåˆæˆ
                await generateImageWithNanoBanana(capturedBase64, backgroundBase64);
            } catch(e) {
                console.error("è¼‰å…¥åœ–ç‰‡æˆ– API å‘¼å«æº–å‚™å¤±æ•—:", e);
                const synthesisCanvas = document.getElementById('synthesisCanvas');
                const loading = document.getElementById('loadingSynthesis');
                const downloadLink = document.getElementById('downloadLink');

                loading.classList.add('hidden');
                synthesisCanvas.classList.remove('hidden');
                const ctx = synthesisCanvas.getContext('2d');
                synthesisCanvas.width = 800;
                synthesisCanvas.height = 450;
                ctx.fillStyle = '#fef2f2';
                ctx.fillRect(0, 0, 800, 450);
                ctx.fillStyle = '#b91c1c';
                ctx.font = '20px Inter, sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText(`åˆæˆæº–å‚™å¤±æ•—ï¼šç„¡æ³•è¼‰å…¥èƒŒæ™¯æˆ–ç›¸æ©Ÿåœ–ç‰‡ã€‚éŒ¯èª¤: ${e.message}`, 400, 225);
                downloadLink.href = '#';
                downloadLink.classList.add('pointer-events-none', 'opacity-50');
            }
        };

        /**
         * å‘¼å« GAS Web App é€²è¡Œé›»å­éƒµä»¶å¯„é€èˆ‡é›²ç«¯ç¡¬ç¢Ÿå‚™ä»½ (åƒ…é©ç”¨æ–¼ 1-3 å¹´ç´š)
         */
        window.sendEmail = async () => {
            const input = document.getElementById('emailAccountInput');
            const message = document.getElementById('emailMessage');
            const sendBtn = document.getElementById('sendEmailBtn');
            const synthesisCanvas = document.getElementById('synthesisCanvas');

            const account = input.value.trim();
            const fullEmail = account + "@chc.edu.tw";

            message.classList.add('hidden');
            message.classList.remove('text-green-600', 'text-red-600');

            if (account.length < 3 || account.includes('@') || account.includes(' ')) {
                message.textContent = 'âŒ è«‹è¼¸å…¥æœ‰æ•ˆçš„å¸³è™Ÿ (ä¸å« @chc.edu.tw)';
                message.classList.add('text-red-600');
                message.classList.remove('hidden');
                return;
            }

            if (!GAS_WEB_APP_URL.includes('google.com')) {
                message.textContent = 'âš ï¸ è«‹å…ˆå°‡ GAS_WEB_APP_URL æ›¿æ›ç‚ºæ‚¨éƒ¨ç½²çš„çœŸå¯¦ GAS ç¶²å€ï¼';
                message.classList.add('text-red-600');
                message.classList.remove('hidden');
                return;
            }

            sendBtn.disabled = true;
            sendBtn.innerHTML = '<svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> <span>æ­£åœ¨å¯„é€èˆ‡å‚™ä»½...</span>';
            lucide.createIcons();

            try {
                // å–å¾—åˆæˆåœ–ç‰‡çš„ Base64 æ•¸æ“š
                const imageBase64 = dataUrlToPureBase64(synthesisCanvas.toDataURL('image/png'));
                
                const response = await fetch(GAS_WEB_APP_URL, {
                    method: 'POST',
                    mode: 'cors', // å•Ÿç”¨ CORS
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        emailAccount: account,
                        imageBase64: imageBase64
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP éŒ¯èª¤: ${response.status}`);
                }

                const result = await response.json();

                if (result.status === 'success') {
                    message.textContent = `âœ… æˆåŠŸï¼ç…§ç‰‡å·²å¯„é€åˆ° ${result.data.email} ä¸¦å‚™ä»½è‡³é›²ç«¯ç¡¬ç¢Ÿã€‚`;
                    message.classList.add('text-green-600');
                } else {
                    message.textContent = `âŒ éŒ¯èª¤ï¼šå¯„ä¿¡/å‚™ä»½å¤±æ•—ã€‚${result.message || 'è«‹æª¢æŸ¥ GAS è…³æœ¬æ—¥èªŒã€‚'}`;
                    message.classList.add('text-red-600');
                }

            } catch (error) {
                console.error("å¯„ä¿¡/å‚™ä»½é€£ç·šéŒ¯èª¤:", error);
                message.textContent = `âŒ é€£ç·šéŒ¯èª¤ï¼šç„¡æ³•å‘¼å« GAS æœå‹™ã€‚éŒ¯èª¤è¨Šæ¯ï¼š${error.message}`;
                message.classList.add('text-red-600');
            } finally {
                message.classList.remove('hidden');
                sendBtn.disabled = false;
                sendBtn.innerHTML = '<i data-lucide="mail" class="w-5 h-5"></i> <span>å†æ¬¡å¯„é€</span>';
                lucide.createIcons();
            }
        };

        // ----------------------------------------------------------------------
        // 6. æ‡‰ç”¨ç¨‹å¼åˆå§‹åŒ– (Initialization)
        // ----------------------------------------------------------------------
        window.onload = () => {
            showView('menuView');
        };

    </script>
</body>
</html>